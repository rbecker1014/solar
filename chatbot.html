<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Solar Chat Assistant â€” Energy Command Center</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="stylesheet" href="dist/output.css" />
  <style>
    :root { --safe-bottom: env(safe-area-inset-bottom, 0px); }
    body{
      min-height:100vh;
      padding-bottom:calc(20px + var(--safe-bottom));
      background:radial-gradient(circle at 20% 20%, rgba(56,189,248,0.12), transparent 55%),
                 radial-gradient(circle at 80% 0%, rgba(14,165,233,0.16), transparent 45%),
                 linear-gradient(160deg, #020617 0%, #0f172a 45%, #1e293b 100%);
      color:#f8fafc;
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    }
    header .app-shell{
      background:linear-gradient(135deg, rgba(148,163,184,0.08) 0%, rgba(148,163,184,0.04) 60%, rgba(148,163,184,0.02) 100%);
      border:1px solid rgba(148,163,184,0.2);
      box-shadow:0 25px 50px -12px rgba(15,23,42,0.45);
      backdrop-filter:blur(18px);
    }
    .chat-container{
      max-width:56rem;
      margin:0 auto;
      padding:0 1rem 2rem;
      display:flex;
      flex-direction:column;
      gap:1rem;
    }
    .chat-card{
      background:rgba(248,250,252,0.95);
      border-radius:1.5rem;
      box-shadow:0 20px 40px rgba(15,23,42,0.2);
      border:1px solid rgba(15,23,42,0.08);
      display:flex;
      flex-direction:column;
      height:calc(100vh - 240px);
      min-height:400px;
      overflow:hidden;
    }
    .chat-header{
      padding:1.25rem 1.5rem;
      border-bottom:1px solid rgba(15,23,42,0.1);
      background:linear-gradient(135deg, rgba(56,189,248,0.08) 0%, rgba(14,165,233,0.04) 100%);
    }
    .chat-header h2{
      font-size:1.25rem;
      font-weight:700;
      color:#0f172a;
      margin:0 0 0.25rem 0;
    }
    .chat-header p{
      font-size:0.875rem;
      color:#475569;
      margin:0;
    }
    #chat-messages{
      flex:1;
      overflow-y:auto;
      padding:1.5rem;
      display:flex;
      flex-direction:column;
      gap:1rem;
      background:rgba(248,250,252,0.5);
    }
    .message{
      display:flex;
      gap:0.75rem;
      max-width:85%;
      animation:slideIn 0.3s ease-out;
    }
    @keyframes slideIn{
      from{
        opacity:0;
        transform:translateY(10px);
      }
      to{
        opacity:1;
        transform:translateY(0);
      }
    }
    .message.user-message{
      align-self:flex-end;
      flex-direction:row-reverse;
    }
    .message-avatar{
      width:36px;
      height:36px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      font-weight:700;
      font-size:0.875rem;
    }
    .user-message .message-avatar{
      background:linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
      color:#fff;
      box-shadow:0 4px 12px rgba(56,189,248,0.3);
    }
    .assistant-message .message-avatar{
      background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color:#38bdf8;
      box-shadow:0 4px 12px rgba(15,23,42,0.2);
    }
    .message-content{
      background:#fff;
      border-radius:1rem;
      padding:0.875rem 1.125rem;
      box-shadow:0 2px 8px rgba(15,23,42,0.08);
      color:#0f172a;
      line-height:1.6;
      border:1px solid rgba(15,23,42,0.06);
    }
    .user-message .message-content{
      background:linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
      color:#fff;
      border:none;
      box-shadow:0 4px 12px rgba(56,189,248,0.2);
    }
    .message-sender{
      font-weight:700;
      font-size:0.75rem;
      text-transform:uppercase;
      letter-spacing:0.05em;
      margin-bottom:0.25rem;
      opacity:0.9;
    }
    .chat-input-container{
      padding:1rem 1.5rem;
      border-top:1px solid rgba(15,23,42,0.1);
      background:rgba(255,255,255,0.9);
      display:flex;
      gap:0.75rem;
      align-items:center;
    }
    #chat-input{
      flex:1;
      border:2px solid rgba(148,163,184,0.3);
      border-radius:0.875rem;
      padding:0.75rem 1rem;
      background:#fff;
      color:#0f172a;
      font-size:0.95rem;
      transition:all 0.2s ease;
      outline:none;
    }
    #chat-input:focus{
      border-color:#38bdf8;
      box-shadow:0 0 0 4px rgba(56,189,248,0.15);
    }
    #chat-input::placeholder{
      color:#94a3b8;
    }
    #chat-send{
      background:linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
      color:#fff;
      border:none;
      border-radius:0.875rem;
      padding:0.75rem 1.5rem;
      font-weight:700;
      font-size:0.95rem;
      cursor:pointer;
      transition:all 0.2s ease;
      box-shadow:0 4px 12px rgba(56,189,248,0.3);
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    #chat-send:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(56,189,248,0.4);
    }
    #chat-send:active{
      transform:translateY(0);
    }
    #chat-send:disabled{
      opacity:0.5;
      cursor:not-allowed;
      transform:none;
    }
    .back-link{
      display:inline-flex;
      align-items:center;
      gap:0.5rem;
      padding:0.625rem 1rem;
      background:rgba(148,163,184,0.15);
      border:1px solid rgba(148,163,184,0.25);
      border-radius:0.75rem;
      color:#f8fafc;
      text-decoration:none;
      font-size:0.875rem;
      font-weight:600;
      transition:all 0.2s ease;
      backdrop-filter:blur(8px);
    }
    .back-link:hover{
      background:rgba(148,163,184,0.25);
      border-color:rgba(148,163,184,0.4);
      transform:translateX(-2px);
    }
    .back-link svg{
      width:18px;
      height:18px;
    }
    .empty-state{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      height:100%;
      color:#64748b;
      text-align:center;
      padding:2rem;
    }
    .empty-state svg{
      width:64px;
      height:64px;
      margin-bottom:1rem;
      opacity:0.5;
    }
    .empty-state h3{
      font-size:1.25rem;
      font-weight:700;
      color:#475569;
      margin:0 0 0.5rem 0;
    }
    .empty-state p{
      font-size:0.95rem;
      color:#64748b;
      margin:0;
    }
    .loading-indicator{
      display:flex;
      gap:0.375rem;
      padding:0.75rem 1rem;
      align-items:center;
    }
    .loading-dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:#64748b;
      animation:bounce 1.4s infinite ease-in-out;
    }
    .loading-dot:nth-child(1){animation-delay:-0.32s}
    .loading-dot:nth-child(2){animation-delay:-0.16s}
    @keyframes bounce{
      0%,80%,100%{transform:scale(0.8);opacity:0.5}
      40%{transform:scale(1);opacity:1}
    }
  </style>
</head>
<body class="antialiased">
  <header class="px-4 pt-6 pb-4">
    <div class="app-shell max-w-3xl mx-auto rounded-3xl px-6 py-4 flex flex-col gap-3 text-slate-100">
      <a href="index.html" class="back-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back to Dashboard
      </a>
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-sky-300/80">AI Assistant</p>
        <h1 class="text-2xl font-semibold">Solar Data Chat</h1>
        <p class="text-sm text-slate-200/80">Ask questions about your solar energy data and get instant insights.</p>
      </div>
    </div>
  </header>

  <div class="chat-container">
    <div class="chat-card">
      <div class="chat-header">
        <h2>Chat with Solar Assistant</h2>
        <p>Ask about production, usage, trends, and more</p>
      </div>

      <div id="chat-messages">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            <path d="M8 10h.01M12 10h.01M16 10h.01"/>
          </svg>
          <h3>Start a conversation</h3>
          <p>Ask me anything about your solar data, energy production, or usage patterns.</p>
        </div>
      </div>

      <div class="chat-input-container">
        <input
          id="chat-input"
          type="text"
          placeholder="Ask about your solar data..."
          autocomplete="off"
        >
        <button id="chat-send">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px">
            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
          </svg>
          Send
        </button>
      </div>
    </div>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  const API_URL = 'https://solar-chatbot-656801194507.us-central1.run.app/chat';
  const chatMessages = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const chatSend = document.getElementById('chat-send');
  
  // Track conversation history
  let conversationHistory = [];

  function removeEmptyState() {
    const emptyState = chatMessages.querySelector('.empty-state');
    if (emptyState) {
      emptyState.remove();
    }
  }

  function addMessage(sender, text, isUser = false) {
    removeEmptyState();

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;

    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = isUser ? 'U' : 'AI';

    const content = document.createElement('div');
    content.className = 'message-content';
    
    if (isUser) {
      content.textContent = text;
    } else {
      content.innerHTML = marked.parse(text);
    }

    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function addLoadingIndicator() {
    removeEmptyState();

    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'message assistant-message';
    loadingDiv.id = 'loading-indicator';

    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = 'AI';

    const content = document.createElement('div');
    content.className = 'message-content loading-indicator';
    content.innerHTML = '<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';

    loadingDiv.appendChild(avatar);
    loadingDiv.appendChild(content);

    chatMessages.appendChild(loadingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function removeLoadingIndicator() {
    const loading = document.getElementById('loading-indicator');
    if (loading) {
      loading.remove();
    }
  }

  async function sendMessage() {
    const msg = chatInput.value.trim();
    if (!msg) return;

    chatInput.disabled = true;
    chatSend.disabled = true;

    addMessage('You', msg, true);
    chatInput.value = '';

    addLoadingIndicator();

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          message: msg,
          conversation_history: conversationHistory
        })
      });

      if (!res.ok) {
        throw new Error(`API error: ${res.status}`);
      }

      const data = await res.json();

      removeLoadingIndicator();
      addMessage('Assistant', data.response, false);
      
      // Update conversation history from response
      conversationHistory = data.conversation_history;

    } catch (error) {
      console.error('Error:', error);
      removeLoadingIndicator();
      addMessage('Assistant', 'Sorry, I encountered an error. Please try again.', false);
    } finally {
      chatInput.disabled = false;
      chatSend.disabled = false;
      chatInput.focus();
    }
  }

  chatSend.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  chatInput.focus();
</script>
</body>
</html>
