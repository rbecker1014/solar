<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Solar Production → BigQuery</title>
    <style>
      body { font-family: system-ui, Arial; padding:16px; }
      label { display:block; margin:8px 0; }
      input { padding:6px 8px; }
      button { padding:8px 12px; }
      #latest { font-weight:bold; margin:12px 0; }
      #status { margin:12px 0; color: #064; font-weight: 500; }
      pre { background:#f6f6f6; border:1px solid #ddd; padding:10px; white-space:pre-wrap; }
    </style>
  </head>
  <body>
    <h2>Solar Production Entry</h2>

    <div id="latest">Most recent date: loading…</div>
    <div id="status">Status: idle</div>

    <label>Date <input id="date" type="date" required></label>
    <label>ITD <input id="itd" type="number" step="any" required placeholder="12345"></label>
    <label>Prod <input id="prod" type="number" step="any" required placeholder="50"></label>
    <button id="btn" type="button">Submit</button>

    <h3>Log</h3>
    <pre id="log"></pre>

    <script>
      const ENDPOINT = "https://script.google.com/macros/s/AKfycbz8cwcHG57A8n9XTTvwvt5pTyejqptINCjTl5BUrkUeZ9VIGIgOCYFHxJsria8xcTXj/exec";
      const TOKEN    = "Rick_c9b8f4f2a0d34d0c9e2b6a7c5f1e4a3d";

      const log = m => {
        const el = document.getElementById('log');
        el.textContent += (typeof m==='string' ? m : JSON.stringify(m)) + "\n";
      };

      async function refreshLatest() {
        try {
          const res = await fetch(`${ENDPOINT}?token=${encodeURIComponent(TOKEN)}`);
          const j = await res.json();
          if (j?.ok && j?.last?.date) {
            document.getElementById('latest').textContent = `Most recent date: ${j.last.date}`;
          } else {
            document.getElementById('latest').textContent = "Most recent date: none";
          }
          log('GET latest: ' + JSON.stringify(j));
        } catch (e) {
          document.getElementById('latest').textContent = "Error fetching latest";
          log('GET error: ' + e.message);
        }
      }

      document.getElementById('btn').addEventListener('click', async () => {
        const date = document.getElementById('date').value;
        const itd  = document.getElementById('itd').value;
        const prod = document.getElementById('prod').value;

        if (!date || !itd || !prod) {
          alert('Please fill all fields');
          return;
        }

        document.getElementById('status').textContent = "Submitting…";

        const body = new URLSearchParams({ token: TOKEN, date, itd, prod }).toString();
        try {
          const res  = await fetch(ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
            body
          });
          const text = await res.text();
          log('POST response: ' + text);

          document.getElementById('status').textContent = "Submitted OK";
          await refreshLatest();
        } catch (e) {
          document.getElementById('status').textContent = "Submit failed";
          log('POST error: ' + e.message);
        }
      });

      // Load the latest record on page load
      refreshLatest();
    </script>
  </body>
</html>

