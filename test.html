<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Solar Production Entry</title>
    <style>
      body { font-family: system-ui, Arial; padding:16px }
      label { display:block; margin:8px 0 }
      input { padding:6px 8px }
      button { padding:8px 12px }
      pre { background:#f6f6f6; border:1px solid #ddd; padding:10px; white-space:pre-wrap }
      #latest { font-weight: bold; margin-top: 12px; }
    </style>
  </head>
  <body>
    <h2>SDEG → BigQuery Entry</h2>

    <label>Date <input id="date" type="date"></label>
    <label>ITD <input id="itd" type="number" step="any" placeholder="12345"></label>
    <label>Prod <input id="prod" type="number" step="any" placeholder="50"></label>
    <button id="btn" type="button">Submit</button>

    <div id="latest">Most recent date: (loading…)</div>

    <h3>Log</h3>
    <pre id="log"></pre>

    <script>
      const ENDPOINT = "https://script.google.com/macros/s/AKfycbx0pKnubeqxxJXvUbmd9vvfxdHCZqleMppnZEajNSCyr5SAqEpP4Id249iA2OBFDpZc/exec";
      const TOKEN    = "Rick_c9b8f4f2a0d34d0c9e2b6a7c5f1e4a3d";

      const log = m => {
        const el=document.getElementById('log');
        el.textContent += (typeof m==='string'?m:JSON.stringify(m))+"\n";
      };

      async function refreshLatest() {
        try {
          const res = await fetch(`${ENDPOINT}?token=${TOKEN}`);
          const j = await res.json();
          if (j.ok && j.last) {
            document.getElementById('latest').textContent =
              "Most recent date: " + j.last.date;
          } else if (j.ok && j.max_date) {
            document.getElementById('latest').textContent =
              "Most recent date: " + j.max_date;
          } else {
            document.getElementById('latest').textContent = "Most recent date: none";
          }
        } catch (e) {
          document.getElementById('latest').textContent = "Error fetching last date";
          log(e.message);
        }
      }

      document.getElementById('btn').addEventListener('click', async () => {
        const date = document.getElementById('date').value;
        const itd  = document.getElementById('itd').value;
        const prod = document.getElementById('prod').value;

        const qs = new URLSearchParams({ token: TOKEN, date, itd, prod });

        try {
          const res = await fetch(ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
            body: qs.toString()
          });
          const text = await res.text();
          log('HTTP ' + res.status + ' ' + text);
          await refreshLatest(); // refresh after successful POST
        } catch (err) {
          log('Submit error: ' + err.message);
        }
      });

      // Load the latest record on page load
      refreshLatest();
    </script>
  </body>
</html>
