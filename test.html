<!doctype html>
<html>
  <body>
    <h3>Solar Production Entry yay</h3>
    <p>Most recent date in table: <strong id="lastDate">Loadingâ€¦</strong></p>

    <form id="f">
      <label>Date <input name="date" type="date" required></label>
      <label>ITD <input name="itd" type="number" step="any" required></label>
      <label>Prod <input name="prod" type="number" step="any" required></label>
      <button>Submit</button>
    </form>

    <pre id="out"></pre>

    <script>
      const ENDPOINT = "https://script.google.com/macros/s/AKfycby_QP0bVI5AsDLbeahSkbKfRBKAzZ2XIY0Rj3AY1CSkhzOxANaEJvPTUgESM93tLrGS/exec";
      const TOKEN = "Rick_c9b8f4f2a0d34d0c9e2b6a7c5f1e4a3d"; // must match SHARED_TOKEN in Apps Script

      // Load most recent date on page load
      async function loadLast() {
        try {
          const res = await fetch(`${ENDPOINT}?token=${TOKEN}`);
          const { ok, last, error } = await res.json();
          if (!ok) throw new Error(error || 'Unknown error');
          document.getElementById('lastDate').textContent = last?.date || 'none';
        } catch (err) {
          document.getElementById('lastDate').textContent = 'Error: ' + err.message;
        }
      }

      // Submit handler
      document.getElementById('f').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        data.itd = Number(data.itd);
        data.prod = Number(data.prod);
        data.token = TOKEN;
        const res = await fetch(ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(data)
        });
        const text = await res.text();
        try {
          const json = JSON.parse(text);
          document.getElementById('out').textContent = JSON.stringify(json, null, 2);
          // Refresh last date after successful write
          if (json.ok) loadLast();
        } catch {
          document.getElementById('out').textContent = text;
        }
      });

      loadLast();
    </script>
  </body>
</html>
